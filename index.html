<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bias Co-Pilot — AI-Enhanced Trading Snapshot</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --muted:#a8b3cf; --text:#e6edf7; --accent:#6ea8fe; --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); }
    header { padding: 24px; border-bottom: 1px solid #1d2430; display:flex; gap:16px; align-items:center; justify-content:space-between; }
    h1 { font-size: 20px; margin: 0; letter-spacing: 0.2px; }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 24px; display:grid; grid-template-columns: 1.15fr 0.85fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid #1d2430; border-radius: 14px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .card h2 { margin: 0; padding: 14px 16px; font-size: 16px; border-bottom: 1px solid #1d2430; color: var(--muted); font-weight:600; }
    .card .body { padding: 14px 16px; display:flex; flex-direction:column; gap:12px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea { width: 100%; background: #0f131a; color: var(--text); border: 1px solid #222a38; border-radius: 10px; padding: 10px 12px; font-size: 14px; outline: none; }
    textarea { min-height: 96px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; background: linear-gradient(180deg, #2a6df6, #1d57d6); color: white; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight:600; }
    .btn.ritual { background: linear-gradient(180deg,#9b59b6,#8e44ad); }
    .btn.secondary { background: #263145; }
    .btn:disabled { opacity: .65; cursor: not-allowed; }
    .tag { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border:1px solid #2b3345; background: #0f141c; color: var(--muted); }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .out { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0d1117; border:1px solid #1d2430; padding:12px; border-radius:12px; min-height: 140px; }
    .status { display:flex; align-items:center; gap:8px; font-size: 12px; color: var(--muted); }
    .score { font-size: 32px; font-weight: 800; }
    .score.good { color: var(--ok); }
    .score.neutral { color: var(--warn); }
    .score.bad { color: var(--bad); }
    footer { padding: 24px; color: var(--muted); text-align:center; }
    .tiny { font-size: 11px; color:#8a95ad; }
    ul.news { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; }
    ul.news li { padding:8px; border:1px solid #1d2430; border-radius:10px; background:#0f141a; }
    ul.news a { color: var(--accent); text-decoration:none; }
    @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Bias Co-Pilot <span class="tag">AI-Enhanced Trading Snapshot</span></h1>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="tag" id="snapTag">Snapshots today: <span id="snapCount">0</span></div>
      <div class="tag" id="costTag">Est. cost today: <span id="costToday">$0.00</span></div>
    </div>
  </header>
  <main class="wrap">
    <section class="card">
      <h2>Inputs</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Provider</label>
            <select id="provider">
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
            </select>
          </div>
          <div>
            <label>Model</label>
            <div class="row">
              <select id="model"></select>
              <button class="btn secondary" id="btnLoadModels">Detect</button>
            </div>
          </div>
        </div>
        <div>
          <label>API Key (local only)</label>
          <input id="apiKey" type="password" autocomplete="off" placeholder="sk-..." />
        </div>

        <div class="card" style="background:#0c1118;">
          <h2>Live Data + News</h2>
          <div class="body">
            <div class="grid-3">
              <div>
                <label>NQ Spot <span id="nqLive" class="tiny muted"></span></label>
                <input id="nq" placeholder="live →" />
              </div>
              <div>
                <label>US10Y % <span id="tnxLive" class="tiny muted"></span></label>
                <input id="tnx" placeholder="live →" />
              </div>
              <div>
                <label>DXY <span id="dxyLive" class="tiny muted"></span></label>
                <input id="dxy" placeholder="live →" />
              </div>
            </div>
            <div class="row">
              <button class="btn" id="btnNewsRefresh">Refresh News</button>
              <button class="btn ritual" id="ritual">Morning Ritual</button>
            </div>
            <ul class="news" id="newsList"></ul>
          </div>
        </div>

        <div>
          <label>Headlines (auto)</label>
          <textarea id="news" placeholder="Headlines appear here…"></textarea>
        </div>
        <div>
          <label>Key Levels</label>
          <textarea id="levels" placeholder="Gaps, VWAP, ON H/L…"></textarea>
        </div>

        <div class="row">
          <button class="btn" id="run">Generate Bias Snapshot (Ctrl+Enter)</button>
          <button class="btn secondary" id="save">Save Settings</button>
        </div>
        <div class="status" id="status">Idle — Hit Morning Ritual to crush it</div>
      </div>
    </section>

    <section class="card">
      <h2>Output</h2>
      <div class="body">
        <div class="row" style="align-items:center">
          <div>
            <div class="muted">AI Bias</div>
            <div id="bias" class="score neutral">—</div>
          </div>
          <div>
            <div class="muted">Confidence</div>
            <div id="conf" class="score neutral">—</div>
          </div>
        </div>
        <div>
          <label>Rationale</label>
          <div id="rationale" class="out"></div>
        </div>
        <div>
          <label>Checklist</label>
          <div id="checklist" class="out"></div>
        </div>
        <div>
          <label>Risks</label>
          <div id="risks" class="out"></div>
        </div>
        <div class="tiny">Last 100 snapshots saved locally • Not financial advice</div>
      </div>
    </section>
  </main>
  <footer>
    Built for Ed by BurtonCraft AI • 100% in-browser • BYO-key
  </footer>

  <script>
    const els = {
      provider: document.getElementById('provider'),
      model: document.getElementById('model'),
      apiKey: document.getElementById('apiKey'),
      nq: document.getElementById('nq'), nqLive: document.getElementById('nqLive'),
      tnx: document.getElementById('tnx'), tnxLive: document.getElementById('tnxLive'),
      dxy: document.getElementById('dxy'), dxyLive: document.getElementById('dxyLive'),
      news: document.getElementById('news'),
      levels: document.getElementById('levels'),
      run: document.getElementById('run'),
      ritual: document.getElementById('ritual'),
      save: document.getElementById('save'),
      status: document.getElementById('status'),
      bias: document.getElementById('bias'),
      conf: document.getElementById('conf'),
      rationale: document.getElementById('rationale'),
      checklist: document.getElementById('checklist'),
      risks: document.getElementById('risks'),
      newsList: document.getElementById('newsList'),
      btnLoadModels: document.getElementById('btnLoadModels'),
      btnNewsRefresh: document.getElementById('btnNewsRefresh')
    };

    function toast(msg) { els.status.textContent = msg; }

    // ====== COST & SNAPS ======
    function today() { return new Date().toISOString().slice(0,10); }
    function incSnap() {
      const snaps = JSON.parse(localStorage.getItem('biascopilot_snaps')||'{}');
      snaps[today()] = (snaps[today()]||0) + 1;
      localStorage.setItem('biascopilot_snaps', JSON.stringify(snaps));
      document.getElementById('snapCount').textContent = snaps[today()];
      updateCost();
    }
    function updateCost() {
      const cfg = { in_cpm:0.15, out_cpm:0.60, in_tok:4096, out_tok:800 };
      const snaps = JSON.parse(localStorage.getItem('biascopilot_snaps')||'{}');
      const cost = (snaps[today()]||0) * ((cfg.in_tok/1e6)*cfg.in_cpm + (cfg.out_tok/1e6)*cfg.out_cpm);
      document.getElementById('costToday').textContent = '$'+cost.toFixed(2);
    }

    // ====== SETTINGS ======
    (function load() {
      const saved = JSON.parse(localStorage.getItem('biascopilot')||'{}');
      Object.keys(saved).forEach(k => els[k] && (els[k].value = saved[k]));
      els.provider.value === 'anthropic' 
        ? loadModels(['claude-3-5-sonnet','claude-3-5-haiku','claude-3-opus']) 
        : loadModels(['gpt-4o-mini','gpt-4o','gpt-4-turbo']);
      updateCost();
    })();
    els.save.addEventListener('click', () => {
      const data = { provider: els.provider.value, model: els.model.value, apiKey: els.apiKey.value, levels: els.levels.value };
      localStorage.setItem('biascopilot', JSON.stringify(data));
      toast('Saved');
    });

    // ====== MODELS ======
    function loadModels(list) {
      els.model.innerHTML = '';
      list.forEach(m => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = m;
        els.model.appendChild(opt);
      });
      els.model.value = list[0];
    }
    els.btnLoadModels.addEventListener('click', async () => {
      toast('Detecting models…');
      try {
        const r = await fetch('https://bias-proxy.edgar-guppy.workers.dev/models', {
          headers: { Authorization: `Bearer ${els.apiKey.value}` }
        });
        if (!r.ok) throw 0;
        const j = await r.json();
        const models = [...new Set(j.data.map(x=>x.id).filter(n=>/^gpt-/.test(n)))].sort();
        loadModels(models.length ? models : ['gpt-4o-mini','gpt-4o']);
        toast('Models loaded');
      } catch {
        loadModels(['gpt-4o-mini','gpt-4o']);
        toast('Using fallback models');
      }
    });
    els.provider.addEventListener('change', () => loadModels(els.provider.value==='openai'?['gpt-4o-mini','gpt-4o']:['claude-3-5-sonnet','claude-3-opus']));

    // ====== LIVE DATA ======
    async function fetchLiveData() {
      const symbols = ['%5ENDX', '%5ETNX', '%5EDXY'];
      const urls = symbols.map(s => `https://thingproxy.freeboard.io/fetch/https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1m&range=1d`);
      try {
        const res = await Promise.all(urls.map(u => fetch(u).then(r=>r.json())));
        const [nq, tnx, dxy] = res.map(x => x.chart.result[0].meta.regularMarketPrice);
        els.nq.value = nq.toFixed(0);   els.nqLive.textContent = `(${nq})`;
        els.tnx.value = tnx.toFixed(2); els.tnxLive.textContent = `(${tnx}%)`;
        els.dxy.value = dxy.toFixed(2); els.dxyLive.textContent = `(${dxy})`;
      } catch(e) { console.warn(e); }
    }

    // ====== NEWS ======
    const RSS = [
      'https://feeds.reuters.com/reuters/marketsNews',
      'https://feeds.reuters.com/reuters/businessNews',
      'https://www.cnbc.com/id/100003114/device/rss/rss.html',
      'https://www.investing.com/rss/news_285.rss'
    ];
    async function fetchRSS(url) {
      const proxies = [
        u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        u => `https://thingproxy.freeboard.io/fetch/${u}`
      ];
      for (const p of proxies) {
        try {
          const r = await fetch(p(url));
          if (!r.ok) continue;
          const xml = await r.text();
          const doc = new DOMParser().parseFromString(xml, 'application/xml');
          return [...doc.querySelectorAll('item')].map(i => ({
            title: i.querySelector('title')?.textContent?.trim(),
            url: i.querySelector('link')?.textContent,
            pub: i.querySelector('pubDate')?.textContent
          }));
        } catch {}
      }
      return [];
    }
    async function autoNews() {
      toast('Fetching news + live data…');
      const all = (await Promise.all(RSS.map(fetchRSS))).flat();
      const recent = all
        .filter(i => Date.now() - new Date(i.pub) < 4*60*60*1000)
        .sort((a,b) => new Date(b.pub) - new Date(a.pub))
        .slice(0,25);
      els.newsList.innerHTML = '';
      recent.forEach(i => {
        const li = document.createElement('li');
        const a = document.createElement('a'); a.href=i.url; a.target='_blank'; a.textContent=i.title;
        li.appendChild(a); els.newsList.appendChild(li);
      });
      els.news.value = recent.map(i=>`- ${i.title}`).join('\n');
      await fetchLiveData();
      toast(`Ready — ${recent.length} headlines loaded`);
    }
    els.btnNewsRefresh.addEventListener('click', autoNews);
    els.ritual.addEventListener('click', async () => { await autoNews(); els.run.click(); });

    // ====== FIXED OPENAI CALL (NO MORE response_format ERRORS) ======
    async function callOpenAI(prompt) {
      const key = els.apiKey.value;
      const model = els.model.value;

      // Try Responses API first (no response_format!)
      try {
        const r = await fetch('https://bias-proxy.edgar-guppy.workers.dev/responses', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
          body: JSON.stringify({
            model,
            input: [{ role: 'user', content: prompt }],
            temperature: 0.2,
            max_output_tokens: 700
          })
        });
        if (r.ok) {
          const j = await r.json();
          return j.output?.[0]?.content?.[0]?.text || j.output_text || '';
        }
      } catch(e) { console.log('Responses failed, falling back…'); }

      // Fallback to Chat Completions (supports json_object)
      const r = await fetch('https://bias-proxy.edgar-guppy.workers.dev/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': ' заключается/application/json', 'Authorization': `Bearer ${key}` },
        body: JSON.stringify({
          model,
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.2,
          response_format: { type: 'json_object' }
        })
      });
      if (!r.ok) throw new Error(`Chat API error: ${await r.text()}`);
      const j = await r.json();
      return j.choices[0].message.content;
    }

    async function callAnthropic(prompt) {
      const r = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'x-api-key': els.apiKey.value,
          'anthropic-version': '2023-06-01',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: els.model.value,
          max_tokens: 800,
          temperature: 0.2,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      return j.content[0].text;
    }

    function buildPrompt() {
      return `You are a trading bias co-pilot for NQ futures (7-9 PM ET).
Output strict JSON only:
{
  "bias": "Bullish|Bearish|Neutral",
  "confidence": 0-100,
  "rationale": ["bullet 1", "bullet 2", ...],
  "checklist": ["entry", "invalidation", ...],
  "risks": ["risk flag 1", ...]
}
Data:
NQ=${els.nq.value||'NA'}  US10Y=${els.tnx.value||'NA'}%  DXY=${els.dxy.value||'NA'}
News:
${els.news.value||'(none)'}
Levels:
${els.levels.value||'(none)'}
Be concise. Trader-ready.`;
    }

    function saveHistory(data) {
      const h = JSON.parse(localStorage.getItem('biascopilot_history')||'[]');
      h.push({ ts: new Date().toISOString(), ...data });
      if (h.length > 100) h.shift();
      localStorage.setItem('biascopilot_history', JSON.stringify(h));
    }

    function render(json) {
      let d;
      try { d = JSON.parse(json); } catch { els.rationale.textContent = json; return; }
      els.bias.textContent = d.bias || 'Neutral';
      els.conf.textContent = (d.confidence||0)+'%';
      els.bias.className = 'score ' + (d.bias.toLowerCase().includes('bull')?'good':d.bias.toLowerCase().includes('bear')?'bad':'neutral');
      els.conf.className = 'score ' + (d.confidence>=67?'good':d.confidence>=34?'neutral':'bad');
      els.rationale.textContent = (d.rationale||[]).map(x=>'• '+x).join('\n');
      els.checklist.textContent = (d.checklist||[]).map(x=>'Check '+x).join('\n');
      els.risks.textContent = (d.risks||[]).map(x=>'Warning '+x).join('\n');
      saveHistory({ bias: d.bias, conf: d.confidence });
    }

    els.run.addEventListener('click', async () => {
      if (!els.apiKey.value) return toast('Add API key first');
      els.run.disabled = true;
      toast('Calling model…');
      try {
        const prompt = buildPrompt();
        const out = els.provider.value==='openai' ? await callOpenAI(prompt) : await callAnthropic(prompt);
        render(out);
        incSnap();
        toast('Bias ready');
      } catch(e) {
        toast('Error: '+e.message);
        console.error(e);
      } finally {
        els.run.disabled = false;
      }
    });

    document.addEventListener('keydown', e => { if(e.ctrlKey && e.key==='Enter') els.run.click(); });
    document.addEventListener('DOMContentLoaded', async () => { await autoNews(); });
  </script>
</body>
</html>
